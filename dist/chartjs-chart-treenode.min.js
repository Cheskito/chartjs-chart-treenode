/*!
 * chartjs-chart-treenode v1.0.0
 * (c) 2025 Francesco Riva
 * Released under the MIT License
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ChartTreeNode=t()}(this,function(){"use strict";const e={id:"treeGraph",afterDraw(e){const t=e.data.datasets[0],l=t.data;if(!l||!Array.isArray(l))return;const o=function(e){const t={};return e.forEach(e=>{t[e.from]||(t[e.from]={label:e.from,children:[],parents:[]}),t[e.to]||(t[e.to]={label:e.to,children:[],parents:[]}),t[e.from].children.push(t[e.to]),t[e.to].parents.push(t[e.from])}),t}(l),{maxDepth:a}=function(e){let l;Object.values(e).forEach(e=>{e.depth=null,e.y=null}),Object.values(e).filter(e=>0===e.parents.length).forEach(e=>e.depth=0);do{l=!1,Object.values(e).forEach(e=>{if(0===e.parents.length)return;const t=Math.max(-1,...e.parents.map(e=>e.depth??-1))+1;(null===e.depth||e.depth<t)&&(e.depth=t,l=!0)})}while(l);const o=t.column||{};Object.entries(e).forEach(([e,t])=>{void 0!==o[e]&&(t.depth=o[e])});const a=new Map;Object.values(e).forEach(e=>{a.has(e.depth)||a.set(e.depth,[]),a.get(e.depth).push(e)});const r=Math.max(...[...a.values()].map(e=>e.length)),n=t.priority||{};return a.forEach((e,t)=>{e.sort((e,t)=>(n[e.label]??Number.MAX_SAFE_INTEGER)-(n[t.label]??Number.MAX_SAFE_INTEGER)||e.label.localeCompare(t.label));const l=1/(r+1),o=(1-l*(e.length-1))/2;e.forEach((e,t)=>e.y=o+t*l)}),{maxDepth:Math.max(...Object.values(e).map(e=>e.depth)),maxY:1}}(o),r=Object.values(o),n=e.ctx,s=e.chartArea;if(r.forEach(e=>{const t=l.filter(t=>t.to===e.label),o=l.filter(t=>t.from===e.label);t.length>0?e.value=t.reduce((e,t)=>e+t.value,0):o.length>0?e.value=o[0].value:e.value=0}),!e._tooltipHandlerAttached){const t=e.canvas;e._hoveredNode=null,t.addEventListener("mousemove",l=>{const o=t.getBoundingClientRect(),a=l.clientX-o.left,n=l.clientY-o.top;e._hoveredNode=null;for(const t of r){const{x:l,y:o}=h(t.depth,t.y),r=a-l,s=n-o;if(Math.sqrt(r*r+s*s)<=10){e._hoveredNode=t;break}}e.draw()}),e._tooltipHandlerAttached=!0}function h(e,t){const l=s.right-s.left-100,o=s.bottom-s.top-80,n=Math.min(...r.map(e=>e.y)),h=(t-n)/(Math.max(...r.map(e=>e.y))-n||1);return{x:s.left+50+e/(a||1)*l,y:s.top+40+h*o}}r.forEach(e=>{e.children.forEach(t=>{const l=h(e.depth,e.y),o=h(t.depth,t.y);n.save(),n.strokeStyle="#888",n.lineWidth=2,n.beginPath();const a=.5*(o.x-l.x);n.moveTo(l.x,l.y),n.bezierCurveTo(l.x+a,l.y,o.x-a,o.y,o.x,o.y),n.stroke(),n.restore()})}),r.forEach(e=>{const{x:l,y:o}=h(e.depth,e.y);n.save();const a=(t.nodeColors||{})[e.label]||"black",r=t.nodeBorder||"0px",s=t.nodeBorderColor||"black";let i=0;"string"==typeof r&&r.endsWith("px")&&(i=parseInt(r.replace("px",""))),i>0&&(n.beginPath(),n.arc(l,o,10+i/2,0,2*Math.PI),n.fillStyle=s,n.fill()),n.beginPath(),n.arc(l,o,10,0,2*Math.PI),n.fillStyle=a,n.fill(),n.font="bold 14px sans-serif",n.fillStyle="#222",n.textAlign="center",n.textBaseline="top",n.fillText(e.label,l,o+14),n.restore()});const i=e._hoveredNode;if(i){const{x:e,y:t}=h(i.depth,i.y),l=`${i.label}: ${i.value}`,o=6;n.save(),n.font="bold 14px sans-serif";const a=n.measureText(l).width,r=20;n.fillStyle="rgba(0,0,0,0.7)",n.fillRect(e-a/2-o,t-30,a+2*o,r),n.fillStyle="#fff",n.textAlign="center",n.textBaseline="middle",n.fillText(l,e,t-20),n.restore()}}};return"undefined"!=typeof window&&window.Chart&&window.Chart.register(e),e});
